<?php//===============================================================class PluginReceptiondesk_ActionAjax extends PluginReceptiondesk_Inherit_ActionAjax{//===============================================================	protected function RegisterEvent(){		parent::RegisterEvent();		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-validate-category$/','EventAjaxReceptiondeskValidateCategoryFields');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-validate-question$/','EventAjaxReceptiondeskValidateQuestionFields');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-get-edit-category$/','EventAjaxReceptiondeskGetEditCategory');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-get-remove-category$/','EventAjaxReceptiondeskGetRemoveCategory');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-remove-category$/','EventAjaxReceptiondeskRemoveCategory');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-remove-question$/','EventAjaxReceptiondeskRemoveQuestion');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-remove-file$/','EventAjaxReceptiondeskRemoveFile');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-redirect-category$/','EventAjaxReceptiondeskRedirectCategory');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-set-category$/','EventAjaxReceptiondeskSetCategory');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-set-question$/','EventAjaxReceptiondeskSetQuestion');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-set-answer$/','EventAjaxReceptiondeskSetAnswer');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-edit-question$/','EventAjaxReceptiondeskEditQuestion');		$this->AddEventPreg('/^receptiondesk$/i','/^ajax-upload-file$/','EventAjaxReceptiondeskUploadFile');	}//===============================================================	protected function EventAjaxReceptiondeskUploadFile(){		if(getRequest('is_iframe')){			$this->Viewer_SetResponseAjax('jsonIframe',false);		}else{			$this->Viewer_SetResponseAjax('json');		}		if(!isset($_FILES['Filedata']['tmp_name'])){			$this->Message_AddError($this->Lang_Get('system_error'),$this->Lang_Get('error'));return false;		}		if(!$_FILES['Filedata']['error']==0){			switch ($_FILES['Filedata']['error']){ 				case UPLOAD_ERR_INI_SIZE: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_ini_size')); 				case UPLOAD_ERR_FORM_SIZE: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_form_size'));				case UPLOAD_ERR_PARTIAL: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_partial'));				case UPLOAD_ERR_NO_FILE: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_no_file'));				case UPLOAD_ERR_NO_TMP_DIR: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_no_tmp_dir'));				case UPLOAD_ERR_CANT_WRITE: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_cant_write'));				case UPLOAD_ERR_EXTENSION: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_extension'));				default: $this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_unknown'));			}  			return false;		}		$sExtension=explode(".",strtolower($_FILES['Filedata']['name']));		$sExtension=array_pop($sExtension);		$aEnabledExtensions=explode(',',Config::Get('plugin.receptiondesk.receptiondesk_create_file_extension'));		if(!in_array($sExtension,$aEnabledExtensions)){			$this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_bad_extension'),$this->Lang_Get('error'));return false;		}		$sTarget=empty($_COOKIE['ls_receptiondesk_file_target_tmp'])?getRequestStr('ls_receptiondesk_file_target_tmp'):$_COOKIE['ls_receptiondesk_file_target_tmp'];		if(!$sTarget){			$this->Message_AddError($this->Lang_Get('system_error').'1',$this->Lang_Get('error'));return false;		}		$iCountFiles=$this->PluginReceptiondesk_Tools_getCountFilesByTargetTmp($sTarget);		if($iCountFiles>=Config::Get('plugin.receptiondesk.receptiondesk_create_file_count_files_max')){			$this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_too_much_files',array('MAX'=>Config::Get('plugin.receptiondesk.receptiondesk_create_file_count_files_max'))),$this->Lang_Get('error'));return false;		}		$sSize=filesize($_FILES['Filedata']['tmp_name']);		if($sSize>Config::Get('plugin.receptiondesk.receptiondesk_create_file_max_size')*1024){			$this->Message_AddError($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_error_bad_filesize',array('MAX'=>Config::Get('plugin.receptiondesk.receptiondesk_create_file_max_size'))),$this->Lang_Get('error'));return false;		}		if($oFile=$this->PluginReceptiondesk_Tools_UploadFile($_FILES['Filedata'])){			$oFile->setTargetTmp($sTarget);			$oFile->setSize($sSize);			if($this->PluginReceptiondesk_Tools_AddFile($oFile)){				$oViewer=$this->Viewer_GetLocalViewer();				$oViewer->Assign('oFile',$oFile);				$this->Viewer_AssignAjax('sFile',$oViewer->Fetch(Plugin::GetTemplatePath(__CLASS__).'admin_files_row.tpl'));				$this->Message_AddNotice($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_ok'),$this->Lang_Get('attention'));			}else{				$this->Message_AddError($this->Lang_Get('system_error').'2',$this->Lang_Get('error'));			}		}else{			$this->Message_AddError($this->Lang_Get('system_error').'3',$this->Lang_Get('error'));		}	}//===============================================================	protected function EventAjaxReceptiondeskRemoveFile(){		$this->Viewer_SetResponseAjax('json');		$sTarget=empty($_COOKIE['ls_receptiondesk_file_target_tmp']) ? null : $_COOKIE['ls_receptiondesk_file_target_tmp'];		$sTarget=$this->oUserCurrent ? null : $sTarget;		if(!$sTarget && !$this->oUserCurrent){			$this->Message_AddError($this->Lang_Get('system_error'),$this->Lang_Get('error'));return false;		}		if(!$oFile=$this->PluginReceptiondesk_Tools_GetFileByTargetTmp(getRequestStr('idTarget'),$sTarget)){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		if($this->PluginReceptiondesk_Tools_DeleteFile($oFile)){			$this->Message_AddNotice($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_author_files_remove_ok'),$this->Lang_Get('attention'));		}else{			$this->Message_AddError($this->Lang_Get('system_error'),$this->Lang_Get('error'));		}	}//===============================================================	protected function EventAjaxReceptiondeskValidateCategoryFields(){		$this->Viewer_SetResponseAjax('json');		$oCategory=Engine::GetEntity('PluginReceptiondesk_ModuleCategory_EntityCategory');		$oCategory->_setValidateScenario('receptiondesk_category');		$aFields=getRequest('fields');		if(is_array($aFields)){			foreach($aFields as $aField){				if(isset($aField['field']) && isset($aField['value'])){					switch($aField['field']){						case 'category_title':$oCategory->setTitle($aField['value']);break;						case 'category_url':$oCategory->setUrl($aField['value']);break;						case 'category_description':$oCategory->setDescription($aField['value']);break;						default:continue;break;					}					$oCategory->_Validate(array($aField['field']),false);				}			}		}		if($oCategory->_hasValidateErrors()) $this->Viewer_AssignAjax('aErrors',$oCategory->_getValidateErrors());	}//===============================================================	protected function EventAjaxReceptiondeskRedirectCategory(){		$this->Viewer_SetResponseAjax('json');		if($sCategoryId=getRequestStr('idTarget')){			if(!$oCategory=$this->PluginReceptiondesk_Category_GetCategoryById($sCategoryId)){				$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;			}			$this->Viewer_AssignAjax('sUrlRedirect',$oCategory->getUrlFull());		}else{			$this->Viewer_AssignAjax('sUrlRedirect',Router::GetPath('receptiondesk'));		}	}//===============================================================	protected function EventAjaxReceptiondeskSetCategory(){		$this->Viewer_SetResponseAjax('json');		if($sCategoryId=getRequestStr('category_id')){			if(!$oCategory=$this->PluginReceptiondesk_Category_GetCategoryById($sCategoryId)){				$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;			}		}else $oCategory=Engine::GetEntity('PluginReceptiondesk_ModuleCategory_EntityCategory');		$oCategory->_setValidateScenario('receptiondesk_category');		$oCategory->setTitle(getRequestStr('category_title'));		$sUrl=getRequestStr('category_url') ? getRequestStr('category_url') : $this->PluginReceptiondesk_Tools_GetTranslit($oCategory->getTitle());		$oCategory->setUrl($sUrl);		$sText=$this->Text_Parser(getRequestStr('category_description'));		$oCategory->setDescription($sText);		if($oCategory->_Validate()){			if($oCategory->getId()){				if($this->PluginReceptiondesk_Category_UpdateCategory($oCategory)){					$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_categories_edit_ок'));				}else{					$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;				}			}else{				if($this->PluginReceptiondesk_Category_AddCategory($oCategory)){					$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_categories_create_ok'));				}else{					$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;				}			}			$oViewer=$this->Viewer_GetLocalViewer();			$aCategories=$this->PluginReceptiondesk_Category_GetCategories();			$oViewer->Assign('aCategories',$aCategories);			$this->Viewer_AssignAjax('sCategoriesList',$oViewer->Fetch(Plugin::GetTemplatePath(__CLASS__).'admin_categories_rows.tpl'));		}else{			$this->Viewer_AssignAjax('aErrors',$oCategory->_getValidateErrors());		}	}//===============================================================	protected function EventAjaxReceptiondeskGetEditCategory(){		$this->Viewer_SetResponseAjax('json');		if(!$oCategory=$this->PluginReceptiondesk_Category_GetCategoryById(getRequestStr('idTarget'))){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		$this->Viewer_AssignAjax('aFields',array(array('field'=>'category_id','value'=>$oCategory->getId()),array('field'=>'category_title','value'=>$oCategory->getTitle()),array('field'=>'category_url','value'=>$oCategory->getUrl()),array('field'=>'category_description','value'=>$oCategory->getDescription()),));	}//===============================================================	protected function EventAjaxReceptiondeskGetRemoveCategory(){		$this->Viewer_SetResponseAjax('json');		if(!$oCategory=$this->PluginReceptiondesk_Category_GetCategoryById(getRequestStr('idTarget'))){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		$oViewer=$this->Viewer_GetLocalViewer();		$aCategories=$this->PluginReceptiondesk_Category_GetCategories();		unset($aCategories[$oCategory->getId()]);		$oViewer->Assign('aCategories',$aCategories);		$this->Viewer_AssignAjax('sCategoriesList',$oViewer->Fetch(Plugin::GetTemplatePath(__CLASS__).'admin_categories_remove_select.tpl'));	}//===============================================================	protected function EventAjaxReceptiondeskRemoveCategory(){		$this->Viewer_SetResponseAjax('json');		if(!$oCategory=$this->PluginReceptiondesk_Category_GetCategoryById(getRequestStr('category_id'))){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		if(($sRemoveCategoryId=getRequestStr('category_remove')) && ($sRemoveCategoryId!=-1)){			if(!($oRemoveCategory=$this->PluginReceptiondesk_Category_GetCategoryById($sRemoveCategoryId))){				$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;			}			$this->PluginReceptiondesk_Question_MoveQuestions($oCategory->getId(),$oRemoveCategory->getId());		}		if($this->PluginReceptiondesk_Category_DeleteCategory($oCategory)){			$oViewer=$this->Viewer_GetLocalViewer();			$aCategories=$this->PluginReceptiondesk_Category_GetCategories();			$oViewer->Assign('aCategories',$aCategories);			$this->Viewer_AssignAjax('sCategoriesList',$oViewer->Fetch(Plugin::GetTemplatePath(__CLASS__).'admin_categories_rows.tpl'));			$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_categories_remove_ok'));		}else{			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}	}//===============================================================	protected function EventAjaxReceptiondeskValidateQuestionFields(){		$this->Viewer_SetResponseAjax('json');		$oQuestion=Engine::GetEntity('PluginReceptiondesk_ModuleQuestion_EntityQuestion');		$oQuestion->_setValidateScenario('receptiondesk_question');		$aFields=getRequest('fields');		if(is_array($aFields)){			foreach($aFields as $aField){				if(isset($aField['field']) && isset($aField['value'])){					switch($aField['field']){						case 'question_category_id':$oQuestion->setCategoryId($aField['value']);break;						case 'question_text':$oQuestion->setText($aField['value']);break;						case 'question_author_mail':$oQuestion->setAuthorValidMail($aField['value']);break;						case 'question_captcha':$oQuestion->setCaptcha($aField['value']);break;						default:continue;break;					}					$oQuestion->_Validate(array($aField['field']),false);				}			}		}		if($oQuestion->_hasValidateErrors()) $this->Viewer_AssignAjax('aErrors',$oQuestion->_getValidateErrors());	}//===============================================================	protected function EventAjaxReceptiondeskSetQuestion(){		$this->Viewer_SetResponseAjax('jsonIframe',false);		$oQuestion=Engine::GetEntity('PluginReceptiondesk_ModuleQuestion_EntityQuestion');		$oQuestion->_setValidateScenario('receptiondesk_question');		$oQuestion->setCategoryId(getRequestStr('question_category_id'));		$oQuestion->setTextSource(getRequestStr('question_text'));		$oQuestion->setText($this->Text_Parser($oQuestion->getTextSource()));		$oQuestion->setCaptcha(getRequestStr('question_captcha'));		$oQuestion->setUserIp(func_getIp());		$oQuestion->setTextHash(md5($oQuestion->getTextSource().$oQuestion->getUserIp()));		$oQuestion->setAuthorValidMail(getRequestStr('question_author_mail'));		if($oQuestion->_Validate()){			$oQuestion->setDateAdd(date("Y-m-d H:i:s"));			$oQuestion->setAuthorMail($oQuestion->getAuthorValidMail());			$oQuestion->setAuthorName(strip_tags(getRequestStr('question_author_name')));			$oQuestion->setAuthorAddress(strip_tags(getRequestStr('question_author_address')));			$oQuestion->setAuthorPhone(strip_tags(getRequestStr('question_author_phone')));			getRequestStr('question_text_hide')!='' ? $oQuestion->setTextHide(1) : $oQuestion->setTextHide(0);			(getRequestStr('question_author_mail_hide')!='' && $oQuestion->getAuthorMail()) ? $oQuestion->setAuthorMailHide(1) : $oQuestion->setAuthorMailHide(0);			(getRequestStr('question_author_name_hide')!='' && $oQuestion->getAuthorName()) ? $oQuestion->setAuthorNameHide(1) :  $oQuestion->setAuthorNameHide(0);			(getRequestStr('question_author_address_hide')!='' && $oQuestion->getAuthorAddress()) ? $oQuestion->setAuthorAddressHide(1) : $oQuestion->setAuthorAddressHide(0);			(getRequestStr('question_author_phone_hide')!='' && $oQuestion->getAuthorPhone()) ? $oQuestion->setAuthorPhoneHide(1) : $oQuestion->setAuthorPhoneHide(0);			if(!$this->PluginReceptiondesk_Question_AddQuestion($oQuestion)){				$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;			}			unset($_SESSION['captcha_keystring']);			$sTarget=empty($_COOKIE['ls_receptiondesk_file_target_tmp']) ? null : $_COOKIE['ls_receptiondesk_file_target_tmp'];			if($sTarget){				$this->PluginReceptiondesk_Tools_UpdateFile($oQuestion->getId(),$sTarget);				setcookie('ls_receptiondesk_file_target_tmp',null);			}			if(Config::Get('plugin.receptiondesk.receptiondesk_create_send_admin')) $this->PluginReceptiondesk_Tools_SendNewQuestionMail($oQuestion);			$this->Viewer_AssignAjax('sUrlRedirect',Router::GetPath('receptiondesk'));			$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_create_ok'));		}else{			$this->Viewer_AssignAjax('aErrors',$oQuestion->_getValidateErrors());		}	}//===============================================================	protected function EventAjaxReceptiondeskRemoveQuestion(){		$this->Viewer_SetResponseAjax('json');		if(!$this->oUserCurrent || !$this->oUserCurrent->isAdministrator()){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		if(!$oQuestion=$this->PluginReceptiondesk_Question_GetQuestionById(getRequestStr('idTarget'))){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		if($this->PluginReceptiondesk_Question_DeleteQuestion($oQuestion->getId())){			$this->Viewer_AssignAjax('sUrlRedirect',Router::GetPath('admin').'receptiondesk/');			$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_remove_ok'));		}else{			$this->Message_AddError($this->Lang_Get('system_error'),$this->Lang_Get('error'));		}	}//===============================================================	protected function EventAjaxReceptiondeskEditQuestion(){		$this->Viewer_SetResponseAjax('jsonIframe',false);		if(!$this->oUserCurrent || !$this->oUserCurrent->isAdministrator()){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		if(!$oQuestion=$this->PluginReceptiondesk_Question_GetQuestionById(getRequestStr('question_id'))){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		$oQuestion->_setValidateScenario('receptiondesk_question_edit');		$oQuestion->setCategoryId(getRequestStr('question_category_id'));		$oQuestion->setTextSource(getRequestStr('question_text'));		$oQuestion->setText($this->Text_Parser($oQuestion->getTextSource()));		if($oQuestion->_Validate()){			$oQuestion->setDateEdit(date("Y-m-d H:i:s"));			if(!$this->PluginReceptiondesk_Question_UpdateQuestion($oQuestion)){				$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;			}			$this->Viewer_AssignAjax('sUrlRedirect',Router::GetPath('admin').'receptiondesk/');			$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_question_edit_ok'));		}else{			$this->Viewer_AssignAjax('aErrors',$oQuestion->_getValidateErrors());		}	}//===============================================================	protected function EventAjaxReceptiondeskSetAnswer(){		$this->Viewer_SetResponseAjax('jsonIframe',false);		if(!($sAnswerText=getRequestStr('answer_text')) && getRequestStr('question_publish') && !Config::Get('plugin.receptiondesk.receptiondesk_create_answer_empty')){			$this->Message_AddErrorSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_answer_create_text_error'));return;		}		if(!$oQuestion=$this->PluginReceptiondesk_Question_GetQuestionById(getRequestStr('question_id'))){			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));return;		}		$oQuestion->setAnswerTextSource($sAnswerText);		$oQuestion->setAnswerText($this->Text_Parser($oQuestion->getAnswerTextSource()));		$oQuestion->setAnswerDateAdd(date("Y-m-d H:i:s"));		if(getRequestStr('question_publish')) $oQuestion->setPublish(1); else $oQuestion->setPublish(0);		if(getRequestStr('answer_mail_send')) $this->PluginReceptiondesk_Tools_SendQuestionMail($oQuestion);		if($this->PluginReceptiondesk_Question_UpdateQuestion($oQuestion)){			if($oQuestion->getPublish())				$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_answer_create_publish_ok'));			else				$this->Message_AddNoticeSingle($this->Lang_Get('plugin.receptiondesk.receptiondesk_admin_answer_create_ok'));		}else{			$this->Message_AddErrorSingle($this->Lang_Get('system_error'));		}	}//===============================================================}?>